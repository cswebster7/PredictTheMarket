var data = [
  {"year": 2001,    "debt": 31.4},
  {"year": 2002,    "debt": 32.6},
  {"year": 2003,    "debt": 34.5},
  {"year": 2004,    "debt": 35.5},
  {"year": 2005,    "debt": 35.6},
  {"year": 2006,    "debt": 35.3},
  {"year": 2007,    "debt": 35.2},
  {"year": 2008,    "debt": 39.3},
  {"year": 2009,    "debt": 52.3},
  {"year": 2010,    "debt": 60.9},
  {"year": 2011,    "debt": 65.9},
  {"year": 2012,    "debt": 70.4},
  {"year": 2013,    "debt": 72.6},
  {"year": 2014,    "debt": 74.4},
  {"year": 2015,    "debt": 73.6},
  {"year": 2016,    "debt": 60.9},
  {"year": 2017,    "debt": 65.9},
  {"year": 2018,    "debt": 70.4},
  {"year": 2019,    "debt": 72.6},
  {"year": 2020,    "debt": 74.4},
  {"year": 2021,    "debt": 73.6},
  {"year": 2022,    "debt": 60.9},
  {"year": 2023,    "debt": 65.9},
  {"year": 2024,    "debt": 70.4},
  {"year": 2025,    "debt": 72.6},
  {"year": 2026,    "debt": 74.4},
  {"year": 2027,    "debt": 68.6},
  {"year": 2028,    "debt": 73.4},
  {"year": 2029,    "debt": 69.6},
  {"year": 2030,    "debt": 65.4},
  {"year": 2031,    "debt": 78.6},
  {"year": 2032,    "debt": 80.6},
  {"year": 2033,    "debt": 31.4},
  {"year": 2034,    "debt": 32.6},
  {"year": 2035,    "debt": 34.5},
  {"year": 2036,    "debt": 35.5},
  {"year": 2037,    "debt": 35.6},
  {"year": 2038,    "debt": 35.3},
  {"year": 2039,    "debt": 35.2},
  {"year": 2040,    "debt": 39.3},
  {"year": 2041,    "debt": 52.3},
  {"year": 2042,    "debt": 60.9},
  {"year": 2043,    "debt": 65.9},
  {"year": 2044,    "debt": 70.4},
  {"year": 2045,    "debt": 72.6},
  {"year": 2046,    "debt": 74.4},
  {"year": 2047,    "debt": 73.6},
  {"year": 2048,    "debt": 60.9},
  {"year": 2049,    "debt": 65.9},
  {"year": 2050,    "debt": 70.4},
  {"year": 2051,    "debt": 72.6},
  {"year": 2052,    "debt": 74.4},
  {"year": 2053,    "debt": 73.6},
  {"year": 2054,    "debt": 60.9},
  {"year": 2055,    "debt": 65.9},
  {"year": 2056,    "debt": 70.4},
  {"year": 2057,    "debt": 72.6},
  {"year": 2058,    "debt": 74.4},
  {"year": 2059,    "debt": 68.6},
  {"year": 2060,    "debt": 73.4},
  {"year": 2061,    "debt": 69.6},
  {"year": 2062,    "debt": 65.4},
  {"year": 2063,    "debt": 78.6},
  {"year": 2064,    "debt": 80.6},
  {"year": 2065,    "debt": 31.4},
  {"year": 2066,    "debt": 32.6},
  {"year": 2067,    "debt": 34.5},
  {"year": 2068,    "debt": 35.5},
  {"year": 2069,    "debt": 35.6},
  {"year": 2070,    "debt": 35.3},
  {"year": 2071,    "debt": 35.2},
  {"year": 2072,    "debt": 39.3},
  {"year": 2073,    "debt": 52.3},
  {"year": 2074,    "debt": 60.9},
  {"year": 2075,    "debt": 65.9},
  {"year": 2076,    "debt": 70.4},
  {"year": 2077,    "debt": 72.6},
  {"year": 2078,    "debt": 74.4},
  {"year": 2079,    "debt": 73.6},
  {"year": 2080,    "debt": 60.9},
  {"year": 2081,    "debt": 65.9},
  {"year": 2082,    "debt": 70.4},
  {"year": 2083,    "debt": 72.6},
  {"year": 2084,    "debt": 74.4},
  {"year": 2085,    "debt": 73.6},
  {"year": 2086,    "debt": 60.9},
  {"year": 2087,    "debt": 65.9},
  {"year": 2088,    "debt": 70.4},
  {"year": 2089,    "debt": 72.6},
  {"year": 2090,    "debt": 74.4},
  {"year": 2091,    "debt": 68.6},
  {"year": 2092,    "debt": 73.4},
  {"year": 2093,    "debt": 69.6},
  {"year": 2094,    "debt": 65.4},
  {"year": 2095,    "debt": 78.6},
  {"year": 2096,    "debt": 80.6},
  {"year": 2097,    "debt": 31.4},
  {"year": 2098,    "debt": 32.6},
  {"year": 2099,    "debt": 34.5},
  {"year": 2100,    "debt": 35.5},
  {"year": 2101,    "debt": 35.6},
  {"year": 2102,    "debt": 35.3},
  {"year": 2103,    "debt": 35.2},
  {"year": 2104,    "debt": 39.3},
  {"year": 2105,    "debt": 52.3},
  {"year": 2106,    "debt": 60.9},
  {"year": 2107,    "debt": 65.9},
  {"year": 2108,    "debt": 70.4},
  {"year": 2109,    "debt": 72.6},
  {"year": 2110,    "debt": 74.4},
  {"year": 2111,    "debt": 73.6},
  {"year": 2112,    "debt": 60.9},
  {"year": 2113,    "debt": 65.9},
  {"year": 2114,    "debt": 70.4},
  {"year": 2115,    "debt": 72.6},
  {"year": 2116,    "debt": 74.4},
  {"year": 2117,    "debt": 73.6},
  {"year": 2118,    "debt": 60.9},
  {"year": 2119,    "debt": 65.9},
  {"year": 2120,    "debt": 70.4},
  {"year": 2121,    "debt": 72.6},
  {"year": 2122,    "debt": 74.4},
  {"year": 2123,    "debt": 68.6},
  {"year": 2124,    "debt": 73.4},
  {"year": 2125,    "debt": 69.6},
  {"year": 2126,    "debt": 65.4},
  {"year": 2127,    "debt": 78.6},
  {"year": 2128,    "debt": 80.6},
]

var ƒ = d3.f

var sel = d3.select('body').html('')
var c = d3.conventions({
  parentSel: sel,
  totalWidth: sel.node().offsetWidth,
  height: 400,
  margin: {left: 50, right: 50, top: 30, bottom: 30}
})

c.svg.append('rect').at({width: c.width, height: c.height, opacity: 0})

c.x.domain([2001, 2128])
c.y.domain([0, 1000])

c.xAxis.ticks(129).tickFormat(ƒ())
c.yAxis.ticks(20).tickFormat(d => d + '%')

var area = d3.area().x(ƒ('year', c.x)).y0(ƒ('debt', c.y)).y1(c.height)
var line = d3.area().x(ƒ('year', c.x)).y(ƒ('debt', c.y))

var clipRect = c.svg
  .append('clipPath#clip')
  .append('rect')
  .at({width: c.x(2015) - 2, height: c.height})

var correctSel = c.svg.append('g').attr('clip-path', 'url(#clip)')

correctSel.append('path.area').at({d: area(data)})
correctSel.append('path.line').at({d: line(data)})
yourDataSel = c.svg.append('path.your-line')

c.drawAxis()

yourData = data
  .map(function(d){ return {year: d.year, debt: d.debt, defined: 0} })
  .filter(function(d){
    if (d.year == 2015) d.defined = true
    return d.year >= 2015
  })

var completed = false

var drag = d3.drag()
  .on('drag', function(){
    var pos = d3.mouse(this)
    var year = clamp(2016, 2128, c.x.invert(pos[0]))
    var debt = clamp(0, c.y.domain()[1], c.y.invert(pos[1]))

    yourData.forEach(function(d){
      if (Math.abs(d.year - year) < 0.5){
        d.debt = debt
        d.defined = true
      }
    })

    yourDataSel.at({d: line.defined(ƒ('defined'))(yourData)})

    if (!completed && d3.mean(yourData, ƒ('defined')) == 1){
      completed = true
      clipRect.transition().duration(5000).attr('width', c.x(2128))
    }
  })

c.svg.call(drag)



function clamp(a, b, c){ return Math.max(a, Math.min(b, c)) }
